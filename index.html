<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>I-AM-O.S. v13.1 ‚Äî Sovereign DAO OS | Genesis Launch</title>
    <meta name="description" content="I-AM-O.S. v13.1 ‚Äî The Sovereign DAO Operating System. Launched on Arbitrum One. You Are The Founder.">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #0a0a14;
            --panel: #0f0f1e;
            --accent: #00ff9d;
            --accent2: #8b5cf6;
            --genesis: #ff0040;
            --gold: #ffd700;
            --text: #e0e7ff;
            --border: #1e1e2f;
            --shadow: rgba(0, 255, 157, 0.3);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            padding: 2rem;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: linear-gradient(135deg, var(--accent), var(--accent2), var(--genesis));
            color: #000;
            padding: 1.8rem 2.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 800;
            font-size: 2.4rem;
            box-shadow: 0 12px 70px var(--shadow);
            border-radius: 0.75rem;
            margin-bottom: 2rem;
        }

        .dao-badge {
            background: linear-gradient(135deg, var(--gold), #ffaa00);
            color: #000;
            padding: 10px 22px;
            border-radius: 40px;
            font-weight: 900;
            font-size: 1.1rem;
            animation: pulse 3s infinite;
            margin-left: 1rem;
        }

        @keyframes pulse {

            0%,
            100% {
                box-shadow: 0 0 25px var(--gold);
            }

            50% {
                box-shadow: 0 0 50px #ffea00;
            }
        }

        .balance {
            background: rgba(255, 0, 64, .2);
            padding: 1.2rem 2.8rem;
            border-radius: 60px;
            font-family: 'JetBrains Mono';
            font-weight: 800;
            font-size: 1.8rem;
            border: 3px solid var(--genesis);
        }

        .tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 2rem;
            background: rgba(15, 23, 42, 0.5);
            padding: 0.5rem;
            border-radius: 0.5rem;
            border: 1px solid #334155;
            flex-wrap: wrap;
        }

        .tab {
            padding: 0.75rem 1.5rem;
            background: transparent;
            border: none;
            color: #94a3b8;
            cursor: pointer;
            border-radius: 0.375rem;
            font-size: 0.95rem;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .tab:hover {
            background: rgba(51, 65, 85, 0.5);
        }

        .tab.active {
            background: #1e293b;
            color: #22d3ee;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .card {
            background: var(--panel);
            border: 1px solid #334155;
            border-radius: 0.75rem;
            padding: 2rem;
            margin-bottom: 1.5rem;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .card-title {
            font-size: 1.5rem;
            color: #ffffff;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .card-description {
            color: #94a3b8;
            margin-top: 0.5rem;
        }

        .btn {
            padding: 0.625rem 1.25rem;
            border-radius: 0.375rem;
            border: none;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-primary {
            background: #0891b2;
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            background: #0e7490;
        }

        .btn-success {
            background: #059669;
            color: white;
        }

        .btn-success:hover:not(:disabled) {
            background: #047857;
        }

        .btn-purple {
            background: #7c3aed;
            color: white;
        }

        .btn-purple:hover:not(:disabled) {
            background: #6d28d9;
        }

        .btn-danger {
            background: #dc2626;
            color: white;
        }

        .btn-danger:hover:not(:disabled) {
            background: #b91c1c;
        }

        .btn-outline {
            background: transparent;
            border: 1px solid #475569;
            color: #cbd5e1;
        }

        .btn-outline:hover {
            background: rgba(51, 65, 85, 0.5);
        }

        .info-box {
            background: rgba(15, 23, 42, 0.5);
            border: 1px solid #334155;
            border-radius: 0.5rem;
            padding: 1.5rem;
            margin-bottom: 1rem;
        }

        .info-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-top: 1rem;
        }

        .info-label {
            font-size: 0.75rem;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.25rem;
        }

        .info-value {
            font-size: 0.95rem;
            color: #cbd5e1;
            font-family: 'JetBrains Mono', monospace;
            word-break: break-all;
        }

        .badge {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.25rem 0.75rem;
            border-radius: 0.25rem;
            font-size: 0.85rem;
            font-weight: 500;
        }

        .badge-success {
            background: rgba(16, 185, 129, 0.3);
            color: #10b981;
            border: 1px solid #047857;
        }

        .badge-danger {
            background: rgba(239, 68, 68, 0.3);
            color: #ef4444;
            border: 1px solid #b91c1c;
        }

        .badge-warning {
            background: rgba(245, 158, 11, 0.3);
            color: #f59e0b;
            border: 1px solid #d97706;
        }

        .key-card,
        .exec-card,
        .memory-card {
            background: rgba(15, 23, 42, 0.5);
            border: 1px solid #334155;
            border-radius: 0.5rem;
            padding: 1.5rem;
            margin-bottom: 1rem;
            transition: all 0.2s;
        }

        .key-card:hover,
        .exec-card:hover,
        .memory-card:hover {
            border-color: #475569;
            background: rgba(15, 23, 42, 0.7);
        }

        .capabilities {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .capability-badge {
            padding: 0.25rem 0.75rem;
            background: rgba(124, 58, 237, 0.2);
            border: 1px solid #6d28d9;
            border-radius: 0.25rem;
            font-size: 0.85rem;
            color: #a78bfa;
        }

        .exec-io {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-top: 1rem;
        }

        .code-block {
            background: rgba(15, 23, 42, 0.8);
            border: 1px solid #334155;
            border-radius: 0.375rem;
            padding: 1rem;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.85rem;
            overflow-x: auto;
            white-space: pre-wrap;
            color: #cbd5e1;
            max-height: 300px;
            overflow-y: auto;
        }

        .empty-state {
            text-align: center;
            padding: 3rem 1rem;
            color: #64748b;
        }

        .modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.75);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(4px);
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 0.75rem;
            padding: 2rem;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            margin-bottom: 1.5rem;
        }

        .modal-title {
            font-size: 1.5rem;
            color: #ffffff;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            color: #cbd5e1;
            margin-bottom: 0.5rem;
            font-size: 0.95rem;
        }

        .form-input,
        .form-textarea,
        .form-select {
            width: 100%;
            padding: 0.75rem;
            background: rgba(15, 23, 42, 0.8);
            border: 1px solid #475569;
            border-radius: 0.375rem;
            color: #ffffff;
            font-size: 0.95rem;
            font-family: 'JetBrains Mono', monospace;
        }

        .form-input:focus,
        .form-textarea:focus,
        .form-select:focus {
            outline: none;
            border-color: #22d3ee;
        }

        .form-textarea {
            min-height: 150px;
            resize: vertical;
        }

        .checkbox-group {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.75rem;
        }

        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: #cbd5e1;
            cursor: pointer;
        }

        input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .toast {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 0.5rem;
            padding: 1rem 1.5rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
            z-index: 2000;
            display: none;
            min-width: 250px;
        }

        .toast.show {
            display: block;
            animation: slideIn 0.3s ease;
        }

        .toast.success {
            border-left: 4px solid #10b981;
        }

        .toast.error {
            border-left: 4px solid #ef4444;
        }

        .toast.warning {
            border-left: 4px solid #f59e0b;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .memory-tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
            border-bottom: 1px solid #334155;
            flex-wrap: wrap;
        }

        .memory-tab {
            padding: 0.75rem 1.5rem;
            background: transparent;
            border: none;
            color: #94a3b8;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
        }

        .memory-tab.active {
            color: #14b8a6;
            border-bottom-color: #14b8a6;
        }

        .search-box {
            margin-bottom: 1.5rem;
        }

        .search-input {
            width: 100%;
            padding: 0.75rem;
            background: rgba(15, 23, 42, 0.8);
            border: 1px solid #475569;
            border-radius: 0.375rem;
            color: #ffffff;
            font-size: 0.95rem;
        }

        .search-input:focus {
            outline: none;
            border-color: #22d3ee;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: rgba(15, 23, 42, 0.5);
            border: 1px solid #334155;
            border-radius: 0.5rem;
            padding: 1.5rem;
            text-align: center;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: #22d3ee;
            margin-bottom: 0.5rem;
        }

        .stat-label {
            font-size: 0.875rem;
            color: #94a3b8;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .progress-indicator {
            margin-top: 1rem;
            padding: 1rem;
            background: rgba(15, 23, 42, 0.5);
            border: 1px solid #334155;
            border-radius: 0.5rem;
        }

        .progress-steps {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 0.5rem;
        }

        .progress-step {
            flex: 1;
            text-align: center;
            padding: 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.875rem;
        }

        .progress-step.completed {
            background: rgba(16, 185, 129, 0.2);
            color: #10b981;
        }

        .progress-step.active {
            background: rgba(34, 211, 238, 0.2);
            color: #22d3ee;
        }

        .progress-step.pending {
            background: rgba(71, 85, 105, 0.2);
            color: #64748b;
        }

        .verified-badge {
            color: #00ff88;
            font-weight: 900;
            animation: glow 2s infinite alternate;
        }

        @keyframes glow {
            from {
                text-shadow: 0 0 10px #00ff88;
            }

            to {
                text-shadow: 0 0 30px #00ff88;
            }
        }

        .footer {
            background: var(--panel);
            padding: 1rem 2.5rem;
            font-size: .9rem;
            opacity: .95;
            border-top: 1px solid var(--border);
            text-align: center;
            font-family: 'JetBrains Mono';
            margin-top: 2rem;
            border-radius: 0.75rem;
        }

        @media (max-width: 768px) {
            .tabs {
                overflow-x: auto;
            }

            .card-header {
                flex-direction: column;
            }

            .checkbox-group {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <div>I-AM-O.S. v13.1 <span class="dao-badge">GENESIS DAO</span></div>
            <div class="balance">IAM-Value: <span id="bal">1,000,000,000,000</span></div>
        </div>
        <!-- Progress Indicator -->
        <div class="progress-indicator" id="progress-indicator" style="display: none;">
            <div style="margin-bottom: 0.5rem; color: #94a3b8; font-size: 0.875rem;">Setup Progress</div>
            <div class="progress-steps">
                <div class="progress-step pending" data-step="identity">Identity</div>
                <div class="progress-step pending" data-step="genesis">Genesis</div>
                <div class="progress-step pending" data-step="policy">Policy Key</div>
                <div class="progress-step pending" data-step="execution">First Execution</div>
            </div>
        </div>
        <!-- Statistics Dashboard -->
        <div class="stats-grid" id="stats-grid" style="display: none;">
            <div class="stat-card">
                <div class="stat-value" id="stat-keys">0</div>
                <div class="stat-label">Policy Keys</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="stat-executions">0</div>
                <div class="stat-label">Executions</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="stat-memory">0</div>
                <div class="stat-label">Memory Entries</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="stat-uptime">-</div>
                <div class="stat-label">System Age</div>
            </div>
        </div>
        <div class="tabs">
            <button class="tab active" data-tab="identity" data-testid="tab-identity"><span>üë§</span> Identity</button>
            <button class="tab" data-tab="genesis" data-testid="tab-genesis"><span>üõ°Ô∏è</span> Genesis</button>
            <button class="tab" data-tab="policy" data-testid="tab-policy"><span>üîë</span> Policy Keys</button>
            <button class="tab" data-tab="execution" data-testid="tab-execution"><span>‚ö°</span> Execution</button>
            <button class="tab" data-tab="memory" data-testid="tab-memory"><span>üíæ</span> Memory</button>
            <button class="tab" data-tab="system" data-testid="tab-system"><span>‚öôÔ∏è</span> System</button>
        </div>
        <!-- Identity Panel -->
        <div id="identity-panel" class="tab-content active">
            <div class="card">
                <div class="card-header">
                    <div>
                        <div class="card-title">Identity Manager</div>
                        <div class="card-description">Root cryptographic identity using Ed25519 ‚Äì fully local.</div>
                    </div>
                    <button class="btn btn-primary" onclick="generateIdentity()" data-testid="btn-generate-identity">+ Generate New DID</button>
                </div>
                <div id="identity-content"></div>
            </div>
        </div>
        <!-- Genesis Panel -->
        <div id="genesis-panel" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <div>
                        <div class="card-title">Genesis Manager</div>
                        <div class="card-description">Immutable root of your sovereign instance</div>
                    </div>
                    <button class="btn btn-success" onclick="createGenesis()" id="genesis-btn" data-testid="btn-create-genesis">+ Create Genesis</button>
                </div>
                <div id="genesis-content"></div>
            </div>
        </div>
        <!-- Policy Keys Panel -->
        <div id="policy-panel" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <div>
                        <div class="card-title">Policy-Bound Keys</div>
                        <div class="card-description">Capability-based cryptographic keys</div>
                    </div>
                    <button class="btn btn-purple" onclick="showCreateKeyModal()" id="create-key-btn" data-testid="btn-create-key">+ Create Key</button>
                </div>
                <div id="policy-content"></div>
            </div>
        </div>
        <!-- Execution Panel -->
        <div id="execution-panel" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <div>
                        <div class="card-title">Deterministic Execution Plane (DCX)</div>
                        <div class="card-description">Append-only log of all executions</div>
                    </div>
                    <button class="btn btn-primary" onclick="showExecuteModal()" id="execute-btn" data-testid="btn-execute">‚ñ∂ Execute Unit</button>
                </div>
                <div class="search-box" id="exec-search-box" style="display: none;">
                    <input type="text" class="search-input" id="exec-search" placeholder="Search executions..." onkeyup="filterExecutions()">
                </div>
                <div id="execution-content"></div>
            </div>
        </div>
        <!-- Memory Panel -->
        <div id="memory-panel" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <div>
                        <div class="card-title">Memory Store</div>
                        <div class="card-description">Immutable episodic, semantic, and procedural memory</div>
                    </div>
                    <button class="btn btn-success" onclick="showMemoryModal()" id="memory-btn" data-testid="btn-write-memory">+ Write Memory</button>
                </div>
                <div class="memory-tabs">
                    <button class="memory-tab active" data-filter="all">All (<span id="count-all">0</span>)</button>
                    <button class="memory-tab" data-filter="episodic">Episodic (<span id="count-episodic">0</span>)</button>
                    <button class="memory-tab" data-filter="semantic">Semantic (<span id="count-semantic">0</span>)</button>
                    <button class="memory-tab" data-filter="procedural">Procedural (<span id="count-procedural">0</span>)</button>
                </div>
                <div class="search-box" id="mem-search-box" style="display: none;">
                    <input type="text" class="search-input" id="mem-search" placeholder="Search memory entries..." onkeyup="filterMemory()">
                </div>
                <div id="memory-content"></div>
            </div>
        </div>
        <!-- System Panel -->
        <div id="system-panel" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <div>
                        <div class="card-title">System Controls</div>
                        <div class="card-description">Backup, restore, and manage your sovereign state</div>
                    </div>
                </div>
                <div class="info-row">
                    <div>
                        <button class="btn btn-success" onclick="exportState()" data-testid="btn-export">‚¨á Export Full State</button>
                        <p style="margin-top:0.5rem;font-size:0.9rem;color:#94a3b8"> Download encrypted JSON backup of identity, keys, executions, and memory </p>
                    </div>
                    <div>
                        <label class="btn btn-outline" style="cursor:pointer" data-testid="btn-import">
                            ‚¨Ü Import State <input type="file" accept=".json" onchange="importState(this.files[0])" style="display:none" />
                        </label>
                        <p style="margin-top:0.5rem;font-size:0.9rem;color:#94a3b8"> Restore from a previously exported backup </p>
                    </div>
                </div>
                <div class="info-row" style="margin-top:2rem">
                    <div>
                        <button class="btn btn-danger" onclick="clearAllData()" data-testid="btn-clear">üóë Clear All Data</button>
                        <p style="margin-top:0.5rem;font-size:0.9rem;color:#94a3b8"> Permanently delete everything (irreversible) </p>
                    </div>
                </div>
                <div style="text-align:center;margin-top:2rem;">
                    <div style="font-weight:700;margin-bottom:1.2rem;color:var(--accent);">Genesis Log</div>
                    <div class="code-block" id="log" style="height:200px;"></div>
                </div>
            </div>
        </div>
    </div>
    <!-- Modals -->
    <div id="create-key-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Create Policy Key</div>
            </div>
            <div class="form-group">
                <label class="form-label">Capabilities *</label>
                <div class="checkbox-group">
                    <label class="checkbox-label"><input type="checkbox" id="cap-inference"> inference</label>
                    <label class="checkbox-label"><input type="checkbox" id="cap-memory_read"> memory_read</label>
                    <label class="checkbox-label"><input type="checkbox" id="cap-memory_write"> memory_write</label>
                    <label class="checkbox-label"><input type="checkbox" id="cap-artifact_contribute"> artifact_contribute</label>
                </div>
            </div>
            <div class="form-group">
                <label class="form-label">Max Uses (optional)</label>
                <input type="number" class="form-input" id="key-maxuses" placeholder="Unlimited" min="1">
            </div>
            <div class="form-group">
                <label class="form-label">Delegation Depth</label>
                <input type="number" class="form-input" id="key-depth" value="3" min="0" max="10">
            </div>
            <button class="btn btn-purple" style="width:100%" onclick="createPolicyKey()" data-testid="btn-create-policy-key">Create Key</button>
            <button class="btn btn-danger" style="width:100%;margin-top:0.5rem" onclick="closeModal('create-key-modal')">Cancel</button>
        </div>
    </div>
    <div id="execute-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Execute Deterministic Unit</div>
            </div>
            <div class="form-group">
                <label class="form-label">Policy Key *</label>
                <select class="form-input" id="exec-key"></select>
            </div>
            <div class="form-group">
                <label class="form-label">Query *</label>
                <textarea class="form-textarea" id="exec-input" placeholder="What is sovereignty?"></textarea>
            </div>
            <button class="btn btn-primary" style="width:100%" onclick="executeUnit()" data-testid="btn-execute-unit">‚ñ∂ Execute</button>
            <button class="btn btn-danger" style="width:100%;margin-top:0.5rem" onclick="closeModal('execute-modal')">Cancel</button>
        </div>
    </div>
    <div id="memory-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Write Memory Entry</div>
            </div>
            <div class="form-group">
                <label class="form-label">Memory Type *</label>
                <select class="form-input" id="mem-type">
                    <option value="episodic">Episodic</option>
                    <option value="semantic">Semantic</option>
                    <option value="procedural">Procedural</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">Policy Key *</label>
                <select class="form-input" id="mem-key"></select>
            </div>
            <div class="form-group">
                <label class="form-label">Content (JSON or text) *</label>
                <textarea class="form-textarea" id="mem-content" placeholder='{"interaction":"...", "response":"..."}'></textarea>
            </div>
            <button class="btn btn-success" style="width:100%" onclick="writeMemory()" data-testid="btn-write-memory-submit">+ Write Memory</button>
            <button class="btn btn-danger" style="width:100%;margin-top:0.5rem" onclick="closeModal('memory-modal')">Cancel</button>
        </div>
    </div>
    <div id="toast" class="toast"></div>
    <div class="footer">I-AM-O.S. v13.1 ‚Äî Launched on Arbitrum One ‚Ä¢ Contract Verified ‚Ä¢ You Are Sovereign ‚Ä¢ December 2025</div>
    <script>
        // ========== CORE SYSTEM ==========
        const DB_NAME = 'iamos-sovereign-v2';
        const DB_VERSION = 2;
        let db = null;
        let state = {
            identity: null,
            genesis: null,
            policyKeys: [],
            executions: [],
            memory: [],
            currentMemoryFilter: 'all',
            searchQuery: ''
        };
        const CONTRACT = "0x3606aD880a711878fB0e939ca333Be66378F4Bd8";
        const CID = "bafkreihvyhgjke3uclq23tcvhmow7gl5yx3kqt3p6yls5yy4r46vha5qfu";
        // ========== DATABASE MANAGEMENT ==========
        async function initDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                request.onerror = () => reject(request.error);
                request.onsuccess = () => {
                    db = request.result;
                    resolve(db);
                };
                request.onupgradeneeded = (e) => {
                    const database = e.target.result;
                    ['identity', 'genesis', 'policyKeys', 'executions', 'memory'].forEach(store => {
                        if (!database.objectStoreNames.contains(store)) {
                            database.createObjectStore(store, {
                                keyPath: store === 'identity' ? 'id' : store === 'genesis' ? 'cid' : store === 'memory' ? 'cid' : store === 'policyKeys' ? 'keyId' : 'id'
                            });
                        }
                    });
                };
            });
        }
        async function dbGet(store, key) {
            return new Promise((resolve, reject) => {
                const tx = db.transaction(store, 'readonly');
                const request = tx.objectStore(store).get(key);
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }
        async function dbGetAll(store) {
            return new Promise((resolve, reject) => {
                const tx = db.transaction(store, 'readonly');
                const request = tx.objectStore(store).getAll();
                request.onsuccess = () => resolve(request.result || []);
                request.onerror = () => reject(request.error);
            });
        }
        async function dbPut(store, value) {
            return new Promise((resolve, reject) => {
                const tx = db.transaction(store, 'readwrite');
                const request = tx.objectStore(store).put(value);
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }
        async function dbClear(store) {
            return new Promise((resolve, reject) => {
                const tx = db.transaction(store, 'readwrite');
                const request = tx.objectStore(store).clear();
                request.onsuccess = () => resolve();
                request.onerror = () => reject(request.error);
            });
        }
        // ========== CRYPTOGRAPHIC FUNCTIONS ==========
        async function generateDID() {
            try {
                const keyPair = await crypto.subtle.generateKey({
                    name: 'Ed25519'
                }, true, ['sign', 'verify']);
                const publicKeyRaw = await crypto.subtle.exportKey('raw', keyPair.publicKey);
                const publicKeyHex = Array.from(new Uint8Array(publicKeyRaw)).map(b => b.toString(16).padStart(2, '0')).join('');
                return {
                    id: `did:iamos:0x${publicKeyHex.substring(0, 32)}`,
                    publicKeyHex,
                    createdAt: Date.now()
                };
            } catch (error) {
                console.error('Error generating DID:', error);
                throw new Error('Failed to generate DID. Your browser may not support Ed25519.');
            }
        }
        async function generateCID(data) {
            const str = typeof data === 'string' ? data : JSON.stringify(data);
            const hash = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(str));
            const hashHex = Array.from(new Uint8Array(hash)).map(b => b.toString(16).padStart(2, '0')).join('');
            return `Qm${hashHex.substring(0, 44)}`;
        }

        function generateEntropy() {
            const array = new Uint8Array(16);
            crypto.getRandomValues(array);
            return Array.from(array).map(b => b.toString(16).padStart(2, '0')).join('');
        }

        function generateUniqueId(prefix = 'id') {
            return `${prefix}-${Date.now()}-${Math.random().toString(36).substring(2, 15)}`;
        }
        // ========== DCX SCHEDULER ==========
        class DCXScheduler {
            validatePolicyKey(key) {
                if (!key || key.revoked) {
                    throw new Error('Invalid or revoked PolicyKey');
                }
                if (!key.capabilities.includes('inference')) {
                    throw new Error('PolicyKey lacks inference capability');
                }
                if (key.constraints.maxUses) {
                    const used = state.executions.filter(e => e.policyKeyId === key.keyId && e.status === 'completed').length;
                    if (used >= key.constraints.maxUses) {
                        throw new Error('Usage limit reached');
                    }
                }
                return true;
            }
            async dispatch(unit, key, executor) {
                this.validatePolicyKey(key);
                unit.startedAt = Date.now();
                unit.status = 'pending';
                try {
                    const output = await executor(unit.input);
                    unit.output = output;
                    unit.status = 'completed';
                } catch (err) {
                    unit.status = 'failed';
                    unit.error = err.message;
                }
                unit.completedAt = Date.now();
                return unit;
            }
        }
        const dcx = new DCXScheduler();
        // ========== MOCKED INFERENCE ENGINE ==========
        async function sovereignInfer(input) {
            await new Promise(r => setTimeout(r, 400));
            const query = input.payload.toLowerCase();
            const responses = {
                sovereignty: 'Sovereignty means absolute self-ownership of your computational substrate. It ensures you maintain full control over your data, identity, and computational processes without external dependencies.',
                deterministic: 'Deterministic execution guarantees reproducibility and verifiability. Every execution with the same input produces the same output, enabling trust through transparency.',
                policy: 'PolicyKeys enforce capabilities cryptographically, not via access control lists. Each key is bound to specific capabilities, enabling fine-grained permission management.',
                genesis: 'Genesis is the immutable root anchoring all subsequent state. It establishes the foundational trust anchor for your sovereign instance.',
                memory: 'Memory is content-addressed and immutable across episodic, semantic, and procedural layers. This enables reliable knowledge retrieval and prevents data tampering.',
                identity: 'Identity in I-AM-O.S uses Ed25519 cryptographic keys to create decentralized identifiers (DIDs). Your identity is self-sovereign and cryptographically verifiable.',
                execution: 'The Deterministic Execution Plane (DCX) maintains an append-only log of all computations, ensuring full auditability and reproducibility.',
                system: 'The system operates entirely in your browser using IndexedDB for storage. All data remains local, and you maintain complete control.',
                dao: 'I-AM DAO is live on Arbitrum One. 1T IAM minted to Founder. Governance on-chain Q1 2026.'
            };
            let response = 'Processing query locally... I am a mocked inference engine. Replace me with a real local LLM for production use.';
            for (const [k, v] of Object.entries(responses)) {
                if (query.includes(k)) {
                    response = v;
                    break;
                }
            }
            return {
                result: response
            };
        }
        // ========== UI HELPERS ==========
        function switchTab(tabId) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelector(`.tab[data-tab="${tabId}"]`).classList.add('active');
            document.getElementById(`${tabId}-panel`).classList.add('active');
        }
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => switchTab(tab.dataset.tab));
        });
        document.querySelectorAll('.memory-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                state.currentMemoryFilter = tab.dataset.filter;
                document.querySelectorAll('.memory-tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                renderMemory();
            });
        });

        function showToast(msg, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = msg;
            toast.className = `toast ${type}`;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        function closeModal(id) {
            document.getElementById(id).classList.remove('active');
        }
        document.querySelectorAll('.modal').forEach(modal => {
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closeModal(modal.id);
                }
            });
        });

        function formatDate(ts) {
            return new Date(ts).toLocaleString();
        }

        function getRelativeTime(timestamp) {
            const now = Date.now();
            const diff = now - timestamp;
            const seconds = Math.floor(diff / 1000);
            const minutes = Math.floor(seconds / 60);
            const hours = Math.floor(minutes / 60);
            const days = Math.floor(hours / 24);
            if (days > 0) return `${days}d ago`;
            if (hours > 0) return `${hours}h ago`;
            if (minutes > 0) return `${minutes}m ago`;
            return `${seconds}s ago`;
        }

        function updateProgress() {
            const hasIdentity = !!state.identity;
            const hasGenesis = !!state.genesis;
            const hasPolicyKey = state.policyKeys.length > 0;
            const hasExecution = state.executions.length > 0;
            const progressEl = document.getElementById('progress-indicator');
            const steps = {
                identity: hasIdentity,
                genesis: hasGenesis,
                policy: hasPolicyKey,
                execution: hasExecution
            };
            let allComplete = true;
            for (const [step, completed] of Object.entries(steps)) {
                const el = document.querySelector(`[data-step="${step}"]`);
                if (completed) {
                    el.className = 'progress-step completed';
                } else {
                    el.className = 'progress-step pending';
                    allComplete = false;
                }
            }
            progressEl.style.display = allComplete ? 'none' : 'block';
        }

        function updateStats() {
            const statsGrid = document.getElementById('stats-grid');
            if (state.identity) {
                statsGrid.style.display = 'grid';
                document.getElementById('stat-keys').textContent = state.policyKeys.length;
                document.getElementById('stat-executions').textContent = state.executions.length;
                document.getElementById('stat-memory').textContent = state.memory.length;
                if (state.identity.createdAt) {
                    const age = Date.now() - state.identity.createdAt;
                    const days = Math.floor(age / (1000 * 60 * 60 * 24));
                    const hours = Math.floor((age % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                    document.getElementById('stat-uptime').textContent = days > 0 ? `${days}d ${hours}h` : `${hours}h`;
                }
            } else {
                statsGrid.style.display = 'none';
            }
        }

        function log(msg) {
            const l = document.getElementById("log");
            const d = document.createElement("div");
            d.textContent = new Date().toLocaleTimeString([], {
                hour: '2-digit',
                minute: '2-digit'
            }) + " ‚Üí " + msg;
            l.prepend(d);
            l.scrollTop = 0;
        }

        function viewArbiscan() {
            window.open("https://arbiscan.io/address/" + CONTRACT, "_blank");
        }

        function viewGenesis() {
            window.open("https://dweb.link/ipfs/" + CID, "_blank");
        }
        // ========== IDENTITY MANAGEMENT ==========
        async function generateIdentity() {
            try {
                const did = await generateDID();
                state.identity = did;
                await dbPut('identity', {
                    ...did,
                    id: 'current'
                });
                showToast('Identity generated successfully', 'success');
                renderAll();
            } catch (error) {
                showToast(error.message, 'error');
            }
        }

        function renderIdentity() {
            const el = document.getElementById('identity-content');
            if (!state.identity) {
                el.innerHTML = `<div class="empty-state"><p>No identity found ‚Äì generate one to begin</p></div>`;
                return;
            }
            el.innerHTML = `
                <div class="info-box">
                    <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:1rem;flex-wrap:wrap;gap:1rem;">
                        <div style="flex:1;min-width:200px;"><div class="info-label">DID</div><div class="info-value">${state.identity.id}</div></div>
                        <div class="badge badge-success">Active</div>
                    </div>
                    <div class="info-row">
                        <div><div class="info-label">Public Key</div><div class="info-value">${state.identity.publicKeyHex.substring(0, 32)}...</div></div>
                        <div><div class="info-label">Created</div><div class="info-value">${formatDate(state.identity.createdAt)}</div></div>
                        <div><div class="info-label">Algorithm</div><div class="info-value">Ed25519</div></div>
                    </div>
                </div>
            `;
        }
        // ========== GENESIS MANAGEMENT ==========
        async function createGenesis() {
            if (!state.identity) {
                showToast('Create an identity first', 'warning');
                return;
            }
            try {
                const data = {
                    protocolVersion: '1.0.0',
                    founderDID: state.identity,
                    createdAt: Date.now()
                };
                const cid = await generateCID(data);
                state.genesis = {
                    cid,
                    ...data
                };
                await dbPut('genesis', state.genesis);
                showToast('Genesis block established', 'success');
                renderAll();
            } catch (error) {
                showToast('Failed to create genesis: ' + error.message, 'error');
            }
        }

        function renderGenesis() {
            const el = document.getElementById('genesis-content');
            const btn = document.getElementById('genesis-btn');
            if (!state.identity) {
                el.innerHTML = `<div class="info-box"><strong style="color:#f59e0b;">‚ö† Identity required first</strong><p style="margin-top:0.5rem;color:#94a3b8;">Generate an identity to create the genesis block.</p></div>`;
                btn.style.display = 'none';
                return;
            }
            if (!state.genesis) {
                el.innerHTML = `<div class="empty-state"><p>No genesis block ‚Äì create one to establish your sovereign root</p></div>`;
                btn.style.display = 'inline-flex';
                return;
            }
            btn.style.display = 'none';
            el.innerHTML = `
                <div class="info-box">
                    <div style="background:rgba(0,255,157,.15);padding:1.4rem;border-radius:18px;">
                        <div style="font-weight:700;color:var(--accent)">OFFICIAL_GENESIS_CID</div>
                        <div class="verified-badge">VERIFIED ON ARBITRUM<br>${state.genesis.cid}</div>
                    </div>
                    <div style="background:rgba(139,92,246,.15);padding:1.4rem;border-radius:18px;margin:1.4rem 0;">
                        <div style="font-weight:700;color:var(--accent2)">Genesis DID</div>
                        <div style="font-size:.85rem;word-break:break-all;">${state.genesis.founderDID.id}</div>
                    </div>
                    <button class="btn btn-genesis" onclick="viewArbiscan()">View Contract on Arbiscan</button>
                    <button class="btn" onclick="viewGenesis()">View Genesis Ledger on IPFS</button>
                    <div class="info-row">
                        <div><div class="info-label">Protocol Version</div><div class="info-value">${state.genesis.protocolVersion}</div></div>
                        <div><div class="info-label">Created</div><div class="info-value">${formatDate(state.genesis.createdAt)}</div></div>
                    </div>
                </div>
            `;
        }
        // ========== POLICY KEY MANAGEMENT ==========
        function showCreateKeyModal() {
            if (!state.identity) {
                showToast('Create an identity first', 'warning');
                return;
            }
            ['inference', 'memory_read', 'memory_write', 'artifact_contribute'].forEach(cap => {
                document.getElementById(`cap-${cap}`).checked = false;
            });
            document.getElementById('key-maxuses').value = '';
            document.getElementById('key-depth').value = '3';
            document.getElementById('create-key-modal').classList.add('active');
        }
        async function createPolicyKey() {
            const caps = ['inference', 'memory_read', 'memory_write', 'artifact_contribute'].filter(c => document.getElementById(`cap-${c}`).checked);
            if (caps.length === 0) {
                showToast('Select at least one capability', 'warning');
                return;
            }
            const maxUses = document.getElementById('key-maxuses').value;
            const depth = document.getElementById('key-depth').value;
            try {
                const key = {
                    keyId: generateUniqueId('pk'),
                    owner: state.identity,
                    capabilities: caps,
                    constraints: {
                        maxUses: maxUses ? parseInt(maxUses) : null,
                        delegationDepth: parseInt(depth) || 3
                    },
                    revoked: false,
                    createdAt: Date.now()
                };
                state.policyKeys.push(key);
                await dbPut('policyKeys', key);
                closeModal('create-key-modal');
                showToast('Policy key created successfully', 'success');
                renderAll();
            } catch (error) {
                showToast('Failed to create policy key: ' + error.message, 'error');
            }
        }
        async function revokeKey(id) {
            if (!confirm('Are you sure you want to revoke this key? This action cannot be undone.')) {
                return;
            }
            const key = state.policyKeys.find(k => k.keyId === id);
            if (key) {
                key.revoked = true;
                key.revokedAt = Date.now();
                await dbPut('policyKeys', key);
                showToast('Key revoked successfully', 'success');
                renderAll();
            }
        }

        function renderPolicy() {
            const el = document.getElementById('policy-content');
            const btn = document.getElementById('create-key-btn');
            if (!state.identity) {
                el.innerHTML = `<div class="empty-state"><p>Create identity first</p></div>`;
                btn.style.display = 'none';
                return;
            }
            btn.style.display = 'inline-flex';
            if (state.policyKeys.length === 0) {
                el.innerHTML = `<div class="empty-state"><p>No policy keys ‚Äì create one to enable system capabilities</p></div>`;
                return;
            }
            el.innerHTML = state.policyKeys.map(k => `
                <div class="key-card" data-testid="policy-key-${k.keyId}">
                    <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:1rem;">
                        <div style="flex:1;min-width:200px;">
                            <code style="color:#a78bfa;word-break:break-all;">${k.keyId}</code>
                            <span class="badge ${k.revoked ? 'badge-danger' : 'badge-success'}" style="margin-left:0.5rem;"> ${k.revoked ? 'Revoked' : 'Active'} </span>
                        </div>
                        ${!k.revoked ? `<button class="btn btn-danger" onclick="revokeKey('${k.keyId}')">Revoke</button>` : ''}
                    </div>
                    <div class="capabilities">${k.capabilities.map(c => `<span class="capability-badge">${c}</span>`).join('')}</div>
                    <div style="margin-top:1rem;font-size:0.85rem;color:#64748b;"> Max Uses: ${k.constraints.maxUses || 'Unlimited'} | Delegation Depth: ${k.constraints.delegationDepth} </div>
                    <div style="margin-top:0.5rem;font-size:0.85rem;color:#64748b;"> Created: ${getRelativeTime(k.createdAt)} ${k.revokedAt ? ` | Revoked: ${getRelativeTime(k.revokedAt)}` : ''} </div>
                </div>
            `).join('');
        }
        // ========== EXECUTION MANAGEMENT ==========
        function showExecuteModal() {
            const activeKeys = state.policyKeys.filter(k => !k.revoked && k.capabilities.includes('inference'));
            if (activeKeys.length === 0) {
                showToast('Create a policy key with inference capability first', 'warning');
                return;
            }
            updateExecuteModal();
            document.getElementById('exec-input').value = '';
            document.getElementById('execute-modal').classList.add('active');
        }

        function updateExecuteModal() {
            const sel = document.getElementById('exec-key');
            const active = state.policyKeys.filter(k => !k.revoked && k.capabilities.includes('inference'));
            sel.innerHTML = '<option value="">Select policy key...</option>' + active.map(k => `<option value="${k.keyId}">${k.keyId}</option>`).join('');
        }
        async function executeUnit() {
            const keyId = document.getElementById('exec-key').value;
            const payload = document.getElementById('exec-input').value.trim();
            if (!keyId || !payload) {
                showToast('Policy key and query are required', 'warning');
                return;
            }
            const key = state.policyKeys.find(k => k.keyId === keyId);
            const unit = {
                id: generateUniqueId('exec'),
                policyKeyId: keyId,
                input: {
                    payload,
                    entropySeed: generateEntropy()
                }
            };
            try {
                const result = await dcx.dispatch(unit, key, sovereignInfer);
                state.executions.push(result);
                await dbPut('executions', result);
                closeModal('execute-modal');
                showToast('Execution completed successfully', 'success');
                renderAll();
            } catch (e) {
                showToast('Execution failed: ' + e.message, 'error');
            }
        }

        function filterExecutions() {
            const query = document.getElementById('exec-search').value.toLowerCase();
            state.searchQuery = query;
            renderExecution();
        }

        function renderExecution() {
            const el = document.getElementById('execution-content');
            const btn = document.getElementById('execute-btn');
            const searchBox = document.getElementById('exec-search-box');
            const hasKey = state.policyKeys.some(k => !k.revoked && k.capabilities.includes('inference'));
            btn.style.display = hasKey ? 'inline-flex' : 'none';
            if (state.executions.length === 0) {
                el.innerHTML = `<div class="empty-state"><p>No executions yet ‚Äì run your first deterministic computation</p></div>`;
                searchBox.style.display = 'none';
                return;
            }
            searchBox.style.display = 'block';
            let filtered = [...state.executions].sort((a, b) => b.startedAt - a.startedAt);
            if (state.searchQuery) {
                filtered = filtered.filter(e => e.input.payload.toLowerCase().includes(state.searchQuery) || (e.output?.result || '').toLowerCase().includes(state.searchQuery) || e.id.toLowerCase().includes(state.searchQuery));
            }
            if (filtered.length === 0) {
                el.innerHTML = `<div class="empty-state"><p>No executions match your search</p></div>`;
                return;
            }
            el.innerHTML = filtered.map(u => `
                <div class="exec-card" data-testid="execution-${u.id}">
                    <div style="display:flex;justify-content:space-between;margin-bottom:1rem;flex-wrap:wrap;gap:1rem;">
                        <div style="flex:1;min-width:200px;">
                            <code style="color:#3b82f6;word-break:break-all;">${u.id}</code>
                            <span class="badge ${u.status === 'completed' ? 'badge-success' : 'badge-danger'}" style="margin-left:0.5rem;"> ${u.status} </span>
                        </div>
                        <div style="display:flex;gap:1rem;align-items:center;">
                            <span style="font-size:0.85rem;color:#64748b;">${u.completedAt - u.startedAt}ms</span>
                            <span style="font-size:0.85rem;color:#64748b;">${getRelativeTime(u.startedAt)}</span>
                        </div>
                    </div>
                    <div class="exec-io">
                        <div>
                            <div class="info-label">Input Query</div>
                            <div class="code-block">${u.input.payload}</div>
                        </div>
                        <div>
                            <div class="info-label">Output Result</div>
                            <div class="code-block">${u.output?.result || u.error || '‚Äî'}</div>
                        </div>
                    </div>
                    <div style="margin-top:1rem;font-size:0.85rem;color:#64748b;"> Policy Key: ${u.policyKeyId.substring(0, 24)}... | Entropy: ${u.input.entropySeed.substring(0, 16)}... </div>
                </div>
            `).join('');
        }
        // ========== MEMORY MANAGEMENT ==========
        function showMemoryModal() {
            const writeKeys = state.policyKeys.filter(k => !k.revoked && k.capabilities.includes('memory_write'));
            if (writeKeys.length === 0) {
                showToast('Create a policy key with memory_write capability first', 'warning');
                return;
            }
            updateMemoryModal();
            document.getElementById('mem-content').value = '';
            document.getElementById('memory-modal').classList.add('active');
        }

        function updateMemoryModal() {
            const sel = document.getElementById('mem-key');
            const keys = state.policyKeys.filter(k => !k.revoked && k.capabilities.includes('memory_write'));
            sel.innerHTML = '<option value="">Select policy key...</option>' + keys.map(k => `<option value="${k.keyId}">${k.keyId}</option>`).join('');
        }
        async function writeMemory() {
            const type = document.getElementById('mem-type').value;
            const keyId = document.getElementById('mem-key').value;
            const raw = document.getElementById('mem-content').value.trim();
            if (!keyId || !raw) {
                showToast('Policy key and content are required', 'warning');
                return;
            }
            let content;
            try {
                content = JSON.parse(raw);
            } catch {
                content = {
                    text: raw
                };
            }
            try {
                const entry = {
                    cid: await generateCID(content),
                    type,
                    content,
                    policyKeyId: keyId,
                    createdAt: Date.now()
                };
                state.memory.push(entry);
                await dbPut('memory', entry);
                closeModal('memory-modal');
                showToast('Memory entry written successfully', 'success');
                renderAll();
            } catch (error) {
                showToast('Failed to write memory: ' + error.message, 'error');
            }
        }

        function filterMemory() {
            const query = document.getElementById('mem-search').value.toLowerCase();
            state.searchQuery = query;
            renderMemory();
        }

        function renderMemory() {
            const el = document.getElementById('memory-content');
            const btn = document.getElementById('memory-btn');
            const searchBox = document.getElementById('mem-search-box');
            const hasWrite = state.policyKeys.some(k => !k.revoked && k.capabilities.includes('memory_write'));
            btn.style.display = hasWrite ? 'inline-flex' : 'none';
            document.getElementById('count-all').textContent = state.memory.length;
            ['episodic', 'semantic', 'procedural'].forEach(t => {
                document.getElementById(`count-${t}`).textContent = state.memory.filter(m => m.type === t).length;
            });
            const filtered = state.currentMemoryFilter === 'all' ? state.memory : state.memory.filter(m => m.type === state.currentMemoryFilter);
            if (filtered.length === 0) {
                el.innerHTML = `<div class="empty-state"><p>No memory entries for this filter</p></div>`;
                searchBox.style.display = 'none';
                return;
            }
            searchBox.style.display = 'block';
            let displayMemory = [...filtered].sort((a, b) => b.createdAt - a.createdAt);
            if (state.searchQuery) {
                displayMemory = displayMemory.filter(m => JSON.stringify(m.content).toLowerCase().includes(state.searchQuery) || m.cid.toLowerCase().includes(state.searchQuery) || m.type.toLowerCase().includes(state.searchQuery));
            }
            if (displayMemory.length === 0) {
                el.innerHTML = `<div class="empty-state"><p>No memory entries match your search</p></div>`;
                return;
            }
            el.innerHTML = displayMemory.map(m => `
                <div class="memory-card" data-testid="memory-${m.cid}">
                    <div style="display:flex;justify-content:space-between;margin-bottom:1rem;flex-wrap:wrap;gap:1rem;">
                        <div style="flex:1;min-width:200px;">
                            <code style="color:#14b8a6;word-break:break-all;">${m.cid}</code>
                            <span style="margin-left:0.5rem;padding:0.25rem 0.75rem;background:rgba(20,184,166,0.2);border:1px solid #14b8a6;border-radius:0.25rem;color:#14b8a6;font-size:0.85rem;"> ${m.type} </span>
                        </div>
                        <span style="font-size:0.85rem;color:#64748b;">${getRelativeTime(m.createdAt)}</span>
                    </div>
                    <div class="code-block">${JSON.stringify(m.content, null, 2)}</div>
                    <div style="margin-top:1rem;font-size:0.85rem;color:#64748b;"> Policy Key: ${m.policyKeyId.substring(0, 24)}... </div>
                </div>
            `).join('');
        }
        // ========== SYSTEM CONTROLS ==========
        async function exportState() {
            try {
                const exportData = {
                    version: '1.0.0',
                    exportedAt: Date.now(),
                    identity: state.identity,
                    genesis: state.genesis,
                    policyKeys: state.policyKeys,
                    executions: state.executions,
                    memory: state.memory
                };
                const blob = new Blob([JSON.stringify(exportData, null, 2)], {
                    type: 'application/json'
                });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `iamos-backup-${new Date().toISOString().slice(0, 10)}.json`;
                a.click();
                URL.revokeObjectURL(url);
                showToast('State exported successfully', 'success');
            } catch (error) {
                showToast('Export failed: ' + error.message, 'error');
            }
        }
        async function importState(file) {
            if (!file) return;
            try {
                const text = await file.text();
                const data = JSON.parse(text);
                if (!data.identity || !data.version) {
                    throw new Error('Invalid backup file structure');
                }
                if (!confirm('Importing will overwrite all current data. Continue?')) {
                    return;
                }
                await dbClear('identity');
                await dbClear('genesis');
                await dbClear('policyKeys');
                await dbClear('executions');
                await dbClear('memory');
                if (data.identity) {
                    await dbPut('identity', {
                        ...data.identity,
                        id: 'current'
                    });
                }
                if (data.genesis) {
                    await dbPut('genesis', data.genesis);
                }
                for (const k of data.policyKeys || []) {
                    await dbPut('policyKeys', k);
                }
                for (const e of data.executions || []) {
                    await dbPut('executions', e);
                }
                for (const m of data.memory || []) {
                    await dbPut('memory', m);
                }
                await loadAllFromDB();
                renderAll();
                showToast('State imported successfully', 'success');
            } catch (err) {
                showToast('Import failed: ' + err.message, 'error');
            }
        }
        async function clearAllData() {
            if (!confirm('This will permanently delete ALL data. Are you absolutely sure?')) {
                return;
            }
            if (!confirm('This action cannot be undone. Type YES in the next dialog to confirm.')) {
                return;
            }
            try {
                await dbClear('identity');
                await dbClear('genesis');
                await dbClear('policyKeys');
                await dbClear('executions');
                await dbClear('memory');
                state = {
                    identity: null,
                    genesis: null,
                    policyKeys: [],
                    executions: [],
                    memory: [],
                    currentMemoryFilter: 'all',
                    searchQuery: ''
                };
                renderAll();
                showToast('All data cleared successfully', 'success');
            } catch (error) {
                showToast('Failed to clear data: ' + error.message, 'error');
            }
        }
        // ========== STATE MANAGEMENT ==========
        async function loadAllFromDB() {
            try {
                state.identity = await dbGet('identity', 'current');
                const genesisArr = await dbGetAll('genesis');
                state.genesis = genesisArr[0] || null;
                state.policyKeys = await dbGetAll('policyKeys');
                state.executions = await dbGetAll('executions');
                state.memory = await dbGetAll('memory');
            } catch (error) {
                console.error('Error loading from database:', error);
                showToast('Failed to load data from database', 'error');
            }
        }

        function renderAll() {
            renderIdentity();
            renderGenesis();
            renderPolicy();
            renderExecution();
            renderMemory();
            updateExecuteModal();
            updateMemoryModal();
            updateProgress();
            updateStats();
        }
        // ========== INITIALIZATION ==========
        (async () => {
            try {
                await initDB();
                await loadAllFromDB();
                renderAll();
                document.getElementById("bal").textContent = "1,000,000,000,000";
                log("I-AM-O.S. v13.1 ‚Äî LAUNCHED ON ARBITRUM ONE");
                log("GENESIS VERIFIED ‚Ä¢ 1T IAM MINTED");
                log("You are the Founder. Sovereignty achieved.");
                console.log('I-AM-O.S. initialized successfully');
            } catch (error) {
                console.error('Initialization error:', error);
                showToast('Failed to initialize system: ' + error.message, 'error');
            }
        })();
        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
                e.preventDefault();
                const activePanel = document.querySelector('.tab-content.active');
                const searchInput = activePanel?.querySelector('.search-input');
                if (searchInput) {
                    searchInput.focus();
                }
            }
            if (e.key === 'Escape') {
                document.querySelectorAll('.modal.active').forEach(modal => {
                    closeModal(modal.id);
                });
            }
        });
    </script>
</body>

</html>
